<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Baby Sleep">
    <title>Baby Sleep Tracker</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f1a;
            color: #e0e0e0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px 16px;
            min-height: 100vh;
        }

        .header { text-align: center; margin-bottom: 24px; }

        .header h1 {
            font-size: 22px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
        }

        .tz-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .tz-select {
            padding: 7px 12px;
            border: 1px solid #333;
            border-radius: 12px;
            background: #1a1a2e;
            color: #e0e0e0;
            font-size: 14px;
            font-family: inherit;
            outline: none;
            cursor: pointer;
        }

        .tz-select:focus { border-color: #6c5ce7; }

        .settings-btn {
            background: none;
            border: none;
            color: #555;
            font-size: 18px;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 8px;
            transition: color 0.2s;
        }

        .settings-btn:hover { color: #6c5ce7; }

        .current-time { font-size: 14px; color: #888; }

        .sleep-button-container {
            display: flex;
            justify-content: center;
            margin: 32px 0;
        }

        .sleep-button {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            transition: transform 0.2s, box-shadow 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        .sleep-button:active { transform: scale(0.95); }

        .sleep-button.awake {
            background: linear-gradient(135deg, #e84393, #fd79a8);
            box-shadow: 0 8px 32px rgba(232, 67, 147, 0.4);
        }

        .sleep-button.sleeping {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            box-shadow: 0 8px 32px rgba(108, 92, 231, 0.4);
        }

        .sleep-button .icon { font-size: 48px; margin-bottom: 8px; }
        .sleep-button .label { font-size: 16px; opacity: 0.9; }

        .sleep-button .photo {
            width: 100px;
            height: 100px;
            object-fit: contain;
            pointer-events: none;
        }

        .timer {
            text-align: center;
            font-size: 36px;
            font-weight: 300;
            margin-bottom: 32px;
            min-height: 44px;
            font-variant-numeric: tabular-nums;
        }

        .timer.sleeping { color: #a29bfe; }
        .timer.awake    { color: #fd79a8; }

        .section-title {
            font-size: 11px;
            font-weight: 600;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            margin-bottom: 12px;
        }

        .section-divider {
            height: 1px;
            background: #1a1a2e;
            margin: 4px 0 24px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: #1a1a2e;
            border-radius: 16px;
            padding: 16px;
            text-align: center;
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 4px;
        }

        .stat-card .label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chart-container {
            background: #1a1a2e;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .chart-wrapper { position: relative; height: 200px; }

        .sessions-list { margin-bottom: 32px; }

        .sessions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .sessions-header h3 {
            font-size: 11px;
            font-weight: 600;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            margin: 0;
        }

        .add-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
            background: #6c5ce7;
            color: #fff;
            font-size: 20px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .add-btn:active { transform: scale(0.9); }

        .session-item {
            background: #1a1a2e;
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .session-item .session-info { flex: 1; }
        .session-item .session-time { font-size: 14px; color: #fff; }
        .session-item .session-duration { font-size: 12px; color: #888; margin-top: 2px; }

        .session-actions { display: flex; gap: 2px; }

        .session-actions button {
            background: none;
            border: none;
            color: #555;
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .session-actions .edit-btn:hover {
            color: #6c5ce7;
            background: rgba(108, 92, 231, 0.1);
        }

        .session-actions .delete-btn:hover {
            color: #e84393;
            background: rgba(232, 67, 147, 0.1);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 16px;
        }

        .modal-card {
            background: #1a1a2e;
            border-radius: 20px;
            padding: 24px;
            width: 100%;
            max-width: 380px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group { margin-bottom: 16px; }

        .form-group label {
            display: block;
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .form-group input[type="datetime-local"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #333;
            border-radius: 12px;
            background: #0f0f1a;
            color: #fff;
            font-size: 16px;
            font-family: inherit;
            outline: none;
            -webkit-appearance: none;
        }

        .form-group input:focus { border-color: #6c5ce7; }

        .form-group input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            filter: invert(0.6);
        }

        .modal-buttons { display: flex; gap: 12px; margin-top: 24px; }

        .modal-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn:active { transform: scale(0.97); }
        .modal-btn.cancel { background: #2a2a3e; color: #888; }
        .modal-btn.save   { background: #6c5ce7; color: #fff; }

        /* Settings modal â€” photo upload */
        .photo-section { margin-bottom: 20px; }

        .photo-section-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .photo-row {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .photo-preview {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
        }

        .photo-preview.sleeping-bg {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
        }

        .photo-preview.awake-bg {
            background: linear-gradient(135deg, #e84393, #fd79a8);
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .photo-preview .placeholder {
            font-size: 28px;
            opacity: 0.5;
        }

        .photo-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .photo-actions button {
            padding: 8px 14px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .photo-actions button:active { transform: scale(0.95); }

        .photo-actions .upload-btn {
            background: #6c5ce7;
            color: #fff;
        }

        .photo-actions .reset-btn {
            background: #2a2a3e;
            color: #888;
        }

        .error-message {
            background: rgba(232, 67, 147, 0.15);
            border: 1px solid rgba(232, 67, 147, 0.3);
            border-radius: 12px;
            padding: 12px 16px;
            text-align: center;
            color: #fd79a8;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .loading { text-align: center; color: #888; padding: 40px; font-size: 16px; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .sleeping-indicator { animation: pulse 2s ease-in-out infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const API_BASE = '/api';

        // ---- Translations ----

        const TRANSLATIONS = {
            en: {
                title: 'Baby Sleep Tracker',
                titleTpl: "{name}'s Sleep Tracker",
                loading: 'Loading\u2026',
                sleeping: 'Sleeping',
                awake: 'Awake',
                tapToWake: 'Tap to wake',
                tapToSleep: 'Tap to sleep',
                today: 'Today',
                wokeUp: 'Woke Up',
                daySleep: 'Day Sleep',
                awakeTime: 'Awake Time',
                naps: 'Naps',
                last7Days: 'Last 7 Days (avg / day)',
                avgSleep: 'Avg Sleep',
                avgNight: 'Avg Night',
                avgDay: 'Avg Day',
                avgNaps: 'Avg Naps',
                recentSessions: 'Recent Sessions',
                addSession: 'Add Session',
                editSession: 'Edit Session',
                start: 'Start',
                end: 'End',
                cancel: 'Cancel',
                save: 'Save',
                deleteConfirm: 'Delete this sleep session?',
                formError: 'Both start and end times are required',
                hours: 'Hours',
                night: 'Night',
                day: 'Day',
                settings: 'Settings',
                sleepPhoto: 'Sleeping photo',
                awakePhoto: 'Awake photo',
                upload: 'Upload',
                reset: 'Reset',
                close: 'Close',
            },
            ru: {
                title: '\u0422\u0440\u0435\u043A\u0435\u0440 \u0441\u043D\u0430',
                titleTpl: '\u0421\u043E\u043D \u2014 {name}',
                loading: '\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430\u2026',
                sleeping: '\u0421\u043F\u0438\u0442',
                awake: '\u041D\u0435 \u0441\u043F\u0438\u0442',
                tapToWake: '\u041D\u0430\u0436\u043C\u0438 \u2014 \u043F\u0440\u043E\u0441\u043D\u0443\u043B\u0441\u044F',
                tapToSleep: '\u041D\u0430\u0436\u043C\u0438 \u2014 \u0443\u0441\u043D\u0443\u043B',
                today: '\u0421\u0435\u0433\u043E\u0434\u043D\u044F',
                wokeUp: '\u041F\u043E\u0434\u044A\u0451\u043C',
                daySleep: '\u0414\u043D\u0435\u0432\u043D\u043E\u0439 \u0441\u043E\u043D',
                awakeTime: '\u0411\u043E\u0434\u0440\u0441\u0442\u0432\u0443\u0435\u0442',
                naps: '\u0421\u043D\u044B',
                last7Days: '7 \u0434\u043D\u0435\u0439 (\u0441\u0440\u0435\u0434./\u0434\u0435\u043D\u044C)',
                avgSleep: '\u0421\u0440\u0435\u0434. \u0441\u043E\u043D',
                avgNight: '\u0421\u0440\u0435\u0434. \u043D\u043E\u0447\u044C',
                avgDay: '\u0421\u0440\u0435\u0434. \u0434\u0435\u043D\u044C',
                avgNaps: '\u0421\u0440\u0435\u0434. \u0441\u043D\u044B',
                recentSessions: '\u0417\u0430\u043F\u0438\u0441\u0438',
                addSession: '\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C',
                editSession: '\u0420\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C',
                start: '\u041D\u0430\u0447\u0430\u043B\u043E',
                end: '\u041A\u043E\u043D\u0435\u0446',
                cancel: '\u041E\u0442\u043C\u0435\u043D\u0430',
                save: '\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C',
                deleteConfirm: '\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u044D\u0442\u0443 \u0437\u0430\u043F\u0438\u0441\u044C?',
                formError: '\u0423\u043A\u0430\u0436\u0438\u0442\u0435 \u043D\u0430\u0447\u0430\u043B\u043E \u0438 \u043A\u043E\u043D\u0435\u0446',
                hours: '\u0427\u0430\u0441\u044B',
                night: '\u041D\u043E\u0447\u044C',
                day: '\u0414\u0435\u043D\u044C',
                settings: '\u041D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0438',
                sleepPhoto: '\u0424\u043E\u0442\u043E \u0441\u043D\u0430',
                awakePhoto: '\u0424\u043E\u0442\u043E \u0431\u043E\u0434\u0440\u0441\u0442.',
                upload: '\u0417\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C',
                reset: '\u0421\u0431\u0440\u043E\u0441',
                close: '\u0417\u0430\u043A\u0440\u044B\u0442\u044C',
            },
            es: {
                title: 'Seguimiento de sue\u00F1o',
                titleTpl: 'Sue\u00F1o de {name}',
                loading: 'Cargando\u2026',
                sleeping: 'Durmiendo',
                awake: 'Despierto',
                tapToWake: 'Toca para despertar',
                tapToSleep: 'Toca para dormir',
                today: 'Hoy',
                wokeUp: 'Despert\u00F3',
                daySleep: 'Sue\u00F1o diurno',
                awakeTime: 'Despierto',
                naps: 'Siestas',
                last7Days: '7 d\u00EDas (prom./d\u00EDa)',
                avgSleep: 'Prom. sue\u00F1o',
                avgNight: 'Prom. noche',
                avgDay: 'Prom. d\u00EDa',
                avgNaps: 'Prom. siestas',
                recentSessions: 'Sesiones',
                addSession: 'Agregar',
                editSession: 'Editar',
                start: 'Inicio',
                end: 'Fin',
                cancel: 'Cancelar',
                save: 'Guardar',
                deleteConfirm: '\u00BFEliminar esta sesi\u00F3n?',
                formError: 'Se requieren inicio y fin',
                hours: 'Horas',
                night: 'Noche',
                day: 'D\u00EDa',
                settings: 'Ajustes',
                sleepPhoto: 'Foto dormido',
                awakePhoto: 'Foto despierto',
                upload: 'Subir',
                reset: 'Restablecer',
                close: 'Cerrar',
            },
        };

        // ---- Timezone options ----

        const TIMEZONE_OPTIONS = [
            { label: 'London', tz: 'Europe/London' },
            { label: 'Paris', tz: 'Europe/Paris' },
            { label: 'Berlin', tz: 'Europe/Berlin' },
            { label: 'Madrid', tz: 'Europe/Madrid' },
            { label: 'Rome', tz: 'Europe/Rome' },
            { label: 'Moscow', tz: 'Europe/Moscow' },
            { label: 'Istanbul', tz: 'Europe/Istanbul' },
            { label: 'Dubai', tz: 'Asia/Dubai' },
            { label: 'Mumbai', tz: 'Asia/Kolkata' },
            { label: 'Bangkok', tz: 'Asia/Bangkok' },
            { label: 'Singapore', tz: 'Asia/Singapore' },
            { label: 'Shanghai', tz: 'Asia/Shanghai' },
            { label: 'Tokyo', tz: 'Asia/Tokyo' },
            { label: 'Sydney', tz: 'Australia/Sydney' },
            { label: 'Auckland', tz: 'Pacific/Auckland' },
            { label: 'S\u00E3o Paulo', tz: 'America/Sao_Paulo' },
            { label: 'New York', tz: 'America/New_York' },
            { label: 'Chicago', tz: 'America/Chicago' },
            { label: 'Denver', tz: 'America/Denver' },
            { label: 'Los Angeles', tz: 'America/Los_Angeles' },
        ];

        // ---- Timezone conversion helpers ----

        function utcToLocalStr(utcStr, tz) {
            if (!utcStr) return '';
            const d = new Date(utcStr);
            const parts = new Intl.DateTimeFormat('en-CA', {
                timeZone: tz,
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', hour12: false,
            }).formatToParts(d);
            const g = (t) => parts.find(p => p.type === t).value;
            let hour = g('hour');
            if (hour === '24') hour = '00';
            return `${g('year')}-${g('month')}-${g('day')}T${hour}:${g('minute')}`;
        }

        function localStrToUTC(localStr, tz) {
            if (!localStr) return '';
            const [datePart, timePart] = localStr.split('T');
            const [y, mo, d] = datePart.split('-').map(Number);
            const [h, mi] = timePart.split(':').map(Number);
            const guess = new Date(Date.UTC(y, mo - 1, d, h, mi));
            const parts = new Intl.DateTimeFormat('en-CA', {
                timeZone: tz,
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', hour12: false,
            }).formatToParts(guess);
            const g = (t) => parseInt(parts.find(p => p.type === t).value);
            let tzH = g('hour');
            if (tzH === 24) tzH = 0;
            const inTz = new Date(Date.UTC(g('year'), g('month') - 1, g('day'), tzH, g('minute')));
            const offsetMs = inTz.getTime() - guess.getTime();
            return new Date(guess.getTime() - offsetMs).toISOString();
        }

        // ---- Image resize helper ----

        function resizeImage(file, maxSize) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.onload = (e) => {
                    const img = new Image();
                    img.onerror = () => reject(new Error('Failed to load image'));
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > maxSize || h > maxSize) {
                            if (w > h) { h = Math.round(h * maxSize / w); w = maxSize; }
                            else       { w = Math.round(w * maxSize / h); h = maxSize; }
                        }
                        canvas.width = w;
                        canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/png'));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // ---- Format helpers ----

        function formatDuration(minutes) {
            if (!minutes && minutes !== 0) return '--';
            const h = Math.floor(minutes / 60);
            const m = Math.round(minutes % 60);
            if (h > 0) return `${h}h ${m}m`;
            return `${m}m`;
        }

        function formatTimerDuration(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = totalSeconds % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        function formatTimeInTz(date, tz) {
            return new Intl.DateTimeFormat('en-GB', {
                timeZone: tz,
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false,
            }).format(date);
        }

        function formatShortTimeInTz(dateStr, tz) {
            if (!dateStr) return '--';
            return new Intl.DateTimeFormat('en-GB', {
                timeZone: tz,
                hour: '2-digit', minute: '2-digit', hour12: false,
            }).format(new Date(dateStr));
        }

        function formatDateTimeInTz(dateStr, tz, locale) {
            return new Intl.DateTimeFormat(locale || 'en-GB', {
                timeZone: tz,
                month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit', hour12: false,
            }).format(new Date(dateStr));
        }

        function localeForLang(lang) {
            if (lang === 'ru') return 'ru-RU';
            if (lang === 'es') return 'es-ES';
            return 'en-GB';
        }

        async function apiFetch(path, options = {}) {
            const res = await fetch(`${API_BASE}${path}`, {
                headers: { 'Content-Type': 'application/json' },
                ...options,
            });
            if (!res.ok) {
                const body = await res.json().catch(() => ({}));
                throw new Error(body.error || `Request failed (${res.status})`);
            }
            return res.json();
        }

        // ---- App ----

        function App() {
            const [config, setConfig] = useState({ language: 'en', baby_name: '' });
            const [timezone, setTimezone] = useState(TIMEZONE_OPTIONS[0]);
            const [currentTime, setCurrentTime] = useState(new Date());
            const [currentSession, setCurrentSession] = useState(null);
            const [todayStats, setTodayStats] = useState(null);
            const [weeklyStats, setWeeklyStats] = useState(null);
            const [sessions, setSessions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [timerMs, setTimerMs] = useState(0);
            const [awakeTimerMs, setAwakeTimerMs] = useState(0);
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            // Session form modal state
            const [editingSession, setEditingSession] = useState(null);
            const [formStart, setFormStart] = useState('');
            const [formEnd, setFormEnd] = useState('');

            // Settings modal + images
            const [showSettings, setShowSettings] = useState(false);
            const [images, setImages] = useState({ sleeping: null, awake: null });
            const sleepingInputRef = useRef(null);
            const awakeInputRef = useRef(null);

            // Translation helper
            const lang = config.language || 'en';
            const t = (key) => (TRANSLATIONS[lang] || TRANSLATIONS.en)[key] || TRANSLATIONS.en[key] || key;
            const locale = localeForLang(lang);

            // Page title
            useEffect(() => {
                const name = config.baby_name;
                document.title = name
                    ? t('titleTpl').replace('{name}', name)
                    : t('title');
            }, [config]);

            // Clock tick
            useEffect(() => {
                const interval = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(interval);
            }, []);

            // Sleep timer
            useEffect(() => {
                if (!currentSession) { setTimerMs(0); return; }
                const startTime = new Date(currentSession.start_time).getTime();
                const update = () => setTimerMs(Date.now() - startTime);
                update();
                const interval = setInterval(update, 1000);
                return () => clearInterval(interval);
            }, [currentSession]);

            // Awake timer
            const lastEndTime = !currentSession && sessions.length > 0
                ? ((sessions.find(s => s.end_time) || {}).end_time || null)
                : null;

            useEffect(() => {
                if (!lastEndTime) { setAwakeTimerMs(0); return; }
                const endTime = new Date(lastEndTime).getTime();
                const update = () => setAwakeTimerMs(Date.now() - endTime);
                update();
                const interval = setInterval(update, 1000);
                return () => clearInterval(interval);
            }, [lastEndTime]);

            // Load sleep data
            const loadData = useCallback(async () => {
                try {
                    const [session, today, weekly, sessionsData] = await Promise.all([
                        apiFetch('/sleep/current'),
                        apiFetch('/sleep/stats/today'),
                        apiFetch('/sleep/stats/weekly'),
                        apiFetch('/sleep/sessions?limit=20'),
                    ]);
                    setCurrentSession(session);
                    setTodayStats(today);
                    setWeeklyStats(weekly);
                    setSessions(sessionsData);
                    setError(null);
                } catch (err) {
                    setError(err.message);
                }
            }, []);

            // Initial load
            useEffect(() => {
                async function init() {
                    try {
                        const [cfg, settings] = await Promise.all([
                            apiFetch('/config'),
                            apiFetch('/settings'),
                        ]);
                        setConfig(cfg);
                        if (settings.timezone) {
                            const found = TIMEZONE_OPTIONS.find(o => o.tz === settings.timezone);
                            if (found) setTimezone(found);
                        }
                        setImages({
                            sleeping: settings.image_sleeping || null,
                            awake: settings.image_awake || null,
                        });
                    } catch (e) {}
                    await loadData();
                    setLoading(false);
                }
                init();
            }, []);

            // Stacked bar chart
            useEffect(() => {
                if (!weeklyStats || !weeklyStats.daily || !chartRef.current) return;
                if (chartInstance.current) { chartInstance.current.destroy(); }

                const ctx = chartRef.current.getContext('2d');
                const days = weeklyStats.daily;

                chartInstance.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: days.map(d => {
                            return new Intl.DateTimeFormat(locale, { month: 'short', day: 'numeric' })
                                .format(new Date(d.date));
                        }),
                        datasets: [
                            {
                                label: t('night'),
                                data: days.map(d => +(d.night_minutes / 60).toFixed(1)),
                                backgroundColor: 'rgba(108, 92, 231, 0.75)',
                                borderColor: 'rgba(108, 92, 231, 1)',
                                borderWidth: 1,
                                borderRadius: 3,
                            },
                            {
                                label: t('day'),
                                data: days.map(d => +(d.day_minutes / 60).toFixed(1)),
                                backgroundColor: 'rgba(232, 67, 147, 0.75)',
                                borderColor: 'rgba(232, 67, 147, 1)',
                                borderWidth: 1,
                                borderRadius: 3,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: { color: '#888', boxWidth: 12, padding: 16 },
                            },
                            tooltip: {
                                callbacks: {
                                    label: item => `${item.dataset.label}: ${item.parsed.y}h`,
                                },
                            },
                        },
                        scales: {
                            x: {
                                stacked: true,
                                ticks: { color: '#666' },
                                grid: { display: false },
                            },
                            y: {
                                stacked: true,
                                ticks: { color: '#666' },
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                title: { display: true, text: t('hours'), color: '#666' },
                            },
                        },
                    },
                });

                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                        chartInstance.current = null;
                    }
                };
            }, [weeklyStats, lang]);

            // ---- Timezone change ----

            const handleTimezoneChange = (e) => {
                const found = TIMEZONE_OPTIONS.find(o => o.tz === e.target.value);
                if (found) {
                    setTimezone(found);
                    apiFetch('/settings/timezone', {
                        method: 'PUT',
                        body: JSON.stringify({ value: found.tz }),
                    }).catch(() => {});
                }
            };

            // ---- Image upload / reset ----

            const handleImageUpload = async (type, file) => {
                try {
                    setError(null);
                    const dataUrl = await resizeImage(file, 300);
                    await apiFetch(`/settings/image_${type}`, {
                        method: 'PUT',
                        body: JSON.stringify({ value: dataUrl }),
                    });
                    setImages(prev => ({ ...prev, [type]: dataUrl }));
                } catch (err) {
                    setError(err.message);
                }
            };

            const handleImageReset = async (type) => {
                try {
                    setError(null);
                    await apiFetch(`/settings/image_${type}`, { method: 'DELETE' });
                    setImages(prev => ({ ...prev, [type]: null }));
                } catch (err) {
                    setError(err.message);
                }
            };

            // ---- Session form handlers ----

            const openAddForm = () => {
                setFormStart('');
                setFormEnd('');
                setEditingSession({});
            };

            const openEditForm = (session) => {
                setFormStart(utcToLocalStr(session.start_time, timezone.tz));
                setFormEnd(utcToLocalStr(session.end_time, timezone.tz));
                setEditingSession(session);
            };

            const closeForm = () => setEditingSession(null);

            const handleSaveSession = async () => {
                try {
                    setError(null);
                    if (!formStart || !formEnd) {
                        setError(t('formError'));
                        return;
                    }
                    const startUTC = localStrToUTC(formStart, timezone.tz);
                    const endUTC = localStrToUTC(formEnd, timezone.tz);

                    if (editingSession.id) {
                        await apiFetch(`/sleep/sessions/${editingSession.id}`, {
                            method: 'PUT',
                            body: JSON.stringify({ start_time: startUTC, end_time: endUTC }),
                        });
                    } else {
                        await apiFetch('/sleep/sessions', {
                            method: 'POST',
                            body: JSON.stringify({ start_time: startUTC, end_time: endUTC }),
                        });
                    }
                    setEditingSession(null);
                    await loadData();
                } catch (err) {
                    setError(err.message);
                }
            };

            // ---- Sleep toggle ----

            const handleToggleSleep = async () => {
                try {
                    setError(null);
                    if (currentSession) {
                        setCurrentSession(null);
                        await apiFetch('/sleep/end', { method: 'POST' });
                    } else {
                        const now = new Date().toISOString();
                        setCurrentSession({ start_time: now });
                        await apiFetch('/sleep/start', { method: 'POST' });
                    }
                    await loadData();
                } catch (err) {
                    setError(err.message);
                    await loadData();
                }
            };

            const handleDeleteSession = async (id) => {
                if (!confirm(t('deleteConfirm'))) return;
                try {
                    setError(null);
                    await apiFetch(`/sleep/sessions/${id}`, { method: 'DELETE' });
                    await loadData();
                } catch (err) {
                    setError(err.message);
                }
            };

            if (loading) {
                return (
                    <div className="app-container">
                        <div className="loading">{t('loading')}</div>
                    </div>
                );
            }

            const isSleeping = !!currentSession;
            const currentPhoto = isSleeping ? images.sleeping : images.awake;
            const pageTitle = config.baby_name
                ? t('titleTpl').replace('{name}', config.baby_name)
                : t('title');

            return (
                <div className="app-container">
                    <div className="header">
                        <h1>{pageTitle}</h1>
                        <div className="tz-row">
                            <select
                                className="tz-select"
                                value={timezone.tz}
                                onChange={handleTimezoneChange}
                            >
                                {TIMEZONE_OPTIONS.map(o => (
                                    <option key={o.tz} value={o.tz}>{o.label}</option>
                                ))}
                            </select>
                            <button
                                className="settings-btn"
                                onClick={() => setShowSettings(true)}
                                title={t('settings')}
                            >{'\u2699'}</button>
                        </div>
                        <div className="current-time">
                            {formatTimeInTz(currentTime, timezone.tz)}
                        </div>
                    </div>

                    {error && <div className="error-message">{error}</div>}

                    <div className="sleep-button-container">
                        <button
                            className={`sleep-button ${isSleeping ? 'sleeping' : 'awake'}`}
                            onClick={handleToggleSleep}
                        >
                            <span className={`icon ${isSleeping ? 'sleeping-indicator' : ''}`}>
                                {currentPhoto
                                    ? <img className="photo" src={currentPhoto} alt="" />
                                    : (isSleeping ? '\u{1F31C}' : '\u{2600}\u{FE0F}')}
                            </span>
                            <span>{isSleeping ? t('sleeping') : t('awake')}</span>
                            <span className="label">
                                {isSleeping ? t('tapToWake') : t('tapToSleep')}
                            </span>
                        </button>
                    </div>

                    <div className={`timer ${isSleeping ? 'sleeping' : 'awake'}`}>
                        {isSleeping
                            ? formatTimerDuration(timerMs)
                            : lastEndTime ? formatTimerDuration(awakeTimerMs) : ''}
                    </div>

                    {todayStats && (
                        <React.Fragment>
                            <div className="section-title">{t('today')}</div>
                            <div className="stats-grid">
                                <div className="stat-card">
                                    <div className="value">
                                        {formatShortTimeInTz(todayStats.woke_up, timezone.tz)}
                                    </div>
                                    <div className="label">{t('wokeUp')}</div>
                                </div>
                                <div className="stat-card">
                                    <div className="value">
                                        {todayStats.woke_up ? formatDuration(todayStats.day_sleep_minutes) : '--'}
                                    </div>
                                    <div className="label">{t('daySleep')}</div>
                                </div>
                                <div className="stat-card">
                                    <div className="value">
                                        {todayStats.woke_up ? formatDuration(todayStats.awake_minutes) : '--'}
                                    </div>
                                    <div className="label">{t('awakeTime')}</div>
                                </div>
                                <div className="stat-card">
                                    <div className="value">
                                        {todayStats.woke_up ? todayStats.naps : '--'}
                                    </div>
                                    <div className="label">{t('naps')}</div>
                                </div>
                            </div>
                        </React.Fragment>
                    )}

                    {weeklyStats && (
                        <React.Fragment>
                            <div className="section-divider" />
                            <div className="section-title">{t('last7Days')}</div>
                            <div className="stats-grid">
                                <div className="stat-card">
                                    <div className="value">
                                        {formatDuration(weeklyStats.averages.total_minutes)}
                                    </div>
                                    <div className="label">{t('avgSleep')}</div>
                                </div>
                                <div className="stat-card">
                                    <div className="value">
                                        {formatDuration(weeklyStats.averages.night_minutes)}
                                    </div>
                                    <div className="label">{t('avgNight')}</div>
                                </div>
                                <div className="stat-card">
                                    <div className="value">
                                        {formatDuration(weeklyStats.averages.day_minutes)}
                                    </div>
                                    <div className="label">{t('avgDay')}</div>
                                </div>
                                <div className="stat-card">
                                    <div className="value">
                                        {weeklyStats.averages.naps}
                                    </div>
                                    <div className="label">{t('avgNaps')}</div>
                                </div>
                            </div>

                            {weeklyStats.daily.length > 0 && (
                                <div className="chart-container">
                                    <div className="chart-wrapper">
                                        <canvas ref={chartRef}></canvas>
                                    </div>
                                </div>
                            )}
                        </React.Fragment>
                    )}

                    <div className="sessions-list">
                        <div className="sessions-header">
                            <h3>{t('recentSessions')}</h3>
                            <button className="add-btn" onClick={openAddForm} title={t('addSession')}>+</button>
                        </div>
                        {sessions.filter(s => s.end_time).map(session => (
                            <div key={session.id} className="session-item">
                                <div className="session-info">
                                    <div className="session-time">
                                        {formatDateTimeInTz(session.start_time, timezone.tz, locale)}
                                        {' \u2192 '}
                                        {formatDateTimeInTz(session.end_time, timezone.tz, locale)}
                                    </div>
                                    <div className="session-duration">
                                        {formatDuration(session.duration_minutes)}
                                    </div>
                                </div>
                                <div className="session-actions">
                                    <button
                                        className="edit-btn"
                                        onClick={() => openEditForm(session)}
                                        title={t('editSession')}
                                    >{'\u270E'}</button>
                                    <button
                                        className="delete-btn"
                                        onClick={() => handleDeleteSession(session.id)}
                                        title={t('deleteConfirm')}
                                    >{'\u2715'}</button>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Session add/edit modal */}
                    {editingSession && (
                        <div className="modal-overlay" onClick={e => { if (e.target === e.currentTarget) closeForm(); }}>
                            <div className="modal-card">
                                <div className="modal-title">
                                    {editingSession.id ? t('editSession') : t('addSession')}
                                </div>
                                <div className="form-group">
                                    <label>{t('start')} ({timezone.label})</label>
                                    <input
                                        type="datetime-local"
                                        value={formStart}
                                        onChange={e => setFormStart(e.target.value)}
                                    />
                                </div>
                                <div className="form-group">
                                    <label>{t('end')} ({timezone.label})</label>
                                    <input
                                        type="datetime-local"
                                        value={formEnd}
                                        onChange={e => setFormEnd(e.target.value)}
                                    />
                                </div>
                                <div className="modal-buttons">
                                    <button className="modal-btn cancel" onClick={closeForm}>{t('cancel')}</button>
                                    <button className="modal-btn save" onClick={handleSaveSession}>{t('save')}</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Settings modal */}
                    {showSettings && (
                        <div className="modal-overlay" onClick={e => { if (e.target === e.currentTarget) setShowSettings(false); }}>
                            <div className="modal-card">
                                <div className="modal-title">{t('settings')}</div>

                                <div className="photo-section">
                                    <div className="photo-section-label">{t('sleepPhoto')}</div>
                                    <div className="photo-row">
                                        <div className="photo-preview sleeping-bg">
                                            {images.sleeping
                                                ? <img src={images.sleeping} alt="" />
                                                : <span className="placeholder">{'\u{1F31C}'}</span>}
                                        </div>
                                        <div className="photo-actions">
                                            <input
                                                type="file"
                                                accept="image/png,image/jpeg"
                                                style={{ display: 'none' }}
                                                ref={sleepingInputRef}
                                                onChange={e => {
                                                    if (e.target.files[0]) handleImageUpload('sleeping', e.target.files[0]);
                                                    e.target.value = '';
                                                }}
                                            />
                                            <button
                                                className="upload-btn"
                                                onClick={() => sleepingInputRef.current.click()}
                                            >{t('upload')}</button>
                                            {images.sleeping && (
                                                <button
                                                    className="reset-btn"
                                                    onClick={() => handleImageReset('sleeping')}
                                                >{t('reset')}</button>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                <div className="photo-section">
                                    <div className="photo-section-label">{t('awakePhoto')}</div>
                                    <div className="photo-row">
                                        <div className="photo-preview awake-bg">
                                            {images.awake
                                                ? <img src={images.awake} alt="" />
                                                : <span className="placeholder">{'\u{2600}\u{FE0F}'}</span>}
                                        </div>
                                        <div className="photo-actions">
                                            <input
                                                type="file"
                                                accept="image/png,image/jpeg"
                                                style={{ display: 'none' }}
                                                ref={awakeInputRef}
                                                onChange={e => {
                                                    if (e.target.files[0]) handleImageUpload('awake', e.target.files[0]);
                                                    e.target.value = '';
                                                }}
                                            />
                                            <button
                                                className="upload-btn"
                                                onClick={() => awakeInputRef.current.click()}
                                            >{t('upload')}</button>
                                            {images.awake && (
                                                <button
                                                    className="reset-btn"
                                                    onClick={() => handleImageReset('awake')}
                                                >{t('reset')}</button>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                <div className="modal-buttons">
                                    <button
                                        className="modal-btn save"
                                        onClick={() => setShowSettings(false)}
                                    >{t('close')}</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
